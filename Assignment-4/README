								   Passive Packet Sniffer
								============================
								============================
								Name 	  	: Neeraj Mohan Dixit
								SBU ID  	: 109951838
                                                                ============================
                                                                ============================
	

=============
COMPILE & RUN
=============
The program has code file "mydump.c" & makefile "Makefile"
The program can be compiled by typing "make" in the project directory (executable name is mydump)
Use "make clean" to delete the executables generated by this program
The input for the program is of type "mydump [-i interface] [-r file] [-s string] expression"
The program can either read from pcap file (-r option) OR can sniff on a live device (-i option) (NOT BOTH)
The program has to be run with root permission (Appropriate error messages given in program)
The program would set the device in PROMISCUOUS mode but some devices/OS do not allow this setting
(We end up capturing the traffic from our own machine in that case)
The command line BPF filter has to match syntax completely else an error is thrown

===============
IMPLEMENTATION
===============
The offline and online mode of operation in determined by the command line arguments
Packets are captured (via both ways) using a callback function
PCAP library is used for capturing packets. API's like pcap_open_live, pcap_open_offline are used for packet capture
Some API's like pcap_compile, pcap_set_filter are used for traffic filtering via BPF filter
Packets of type ARP, TCP, UDP, ICMP are printed along with their payloads
Some code is adopted from websites like https://www.winpcap.org/docs/docs_40_2/html/group__wpcap__tut6.html
Payload filter capacity is provided via -s option in command line
Traffic can also be filtered via BPF filter (<expression> in command line)
Search string consisting of white spaces have to included within quotes

=============
SAMPLE O/P
=============
neeraj@neeraj:~/Desktop/Network-Security/Assignment-2$ sudo ./mydump -i wlan0 tcp
[sudo] password for neeraj: 

Sniffing on interface: wlan0

Setting BPF filter: tcp 

1th packet: Fri Mar 11 22:47:48 2016	Ether-type: IP (0x0800)	
Source MAC Address:  e8:b1:fc:95:48:4f	Destination MAC Address:  b8:af:67:63:a3:28
Source IP Address: 172.24.20.121 	Destination IP Address: 208.113.163.124 
TCP packet 	Source Port: 43027 	Destn Port: 80	TCP Length = 30
=============
TCP PAYLOAD:
=============
 00  00  a0  02  72  10  d6  18  00  00  02  04  05  b4  04 		....r..........
 02  08  0a  00  31  64  3e  00  00  00  00  01  03  03  07 		....1d>........


=======================================================================

2th packet: Fri Mar 11 22:47:48 2016	Ether-type: IP (0x0800)	
Source MAC Address:  e8:b1:fc:95:48:4f	Destination MAC Address:  b8:af:67:63:a3:28
Source IP Address: 172.24.20.121 	Destination IP Address: 208.113.163.124 
TCP packet 	Source Port: 43028 	Destn Port: 80	TCP Length = 30
=============
TCP PAYLOAD:
=============
 00  00  a0  02  72  10  40  77  00  00  02  04  05  b4  04 		....r.@w.......
 02  08  0a  00  31  64  3e  00  00  00  00  01  03  03  07 		....1d>........


=======================================================================

3th packet: Fri Mar 11 22:47:48 2016	Ether-type: IP (0x0800)	
Source MAC Address:  e8:b1:fc:95:48:4f	Destination MAC Address:  b8:af:67:63:a3:28
Source IP Address: 172.24.20.121 	Destination IP Address: 208.113.163.124 
TCP packet 	Source Port: 43029 	Destn Port: 80	TCP Length = 30
=============
TCP PAYLOAD:
=============
 00  00  a0  02  72  10  78  da  00  00  02  04  05  b4  04 		....r.x........
 02  08  0a  00  31  64  3e  00  00  00  00  01  03  03  07 		....1d>........


=======================================================================

4th packet: Fri Mar 11 22:47:48 2016	Ether-type: IP (0x0800)	
Source MAC Address:  e8:b1:fc:95:48:4f	Destination MAC Address:  b8:af:67:63:a3:28
Source IP Address: 172.24.20.121 	Destination IP Address: 208.113.163.124 
TCP packet 	Source Port: 43030 	Destn Port: 80	TCP Length = 30
=============
TCP PAYLOAD:
=============
 00  00  a0  02  72  10  83  13  00  00  02  04  05  b4  04 		....r..........
 02  08  0a  00  31  64  3e  00  00  00  00  01  03  03  07 		....1d>........


=======================================================================

5th packet: Fri Mar 11 22:47:48 2016	Ether-type: IP (0x0800)	
Source MAC Address:  b8:af:67:63:a3:28	Destination MAC Address:  e8:b1:fc:95:48:4f
Source IP Address: 208.113.163.124 	Destination IP Address: 172.24.20.121 
TCP packet 	Source Port: 80 	Destn Port: 43027	TCP Length = 24
=============
TCP PAYLOAD:
=============
 fc  c3  c1  c1  80  12  39  08  38  76  00  00  02  04  05 		......9.8v.....
 64  01  01  04  02  01  03  03  07 		d........v.....


=======================================================================


root@neeraj:~/Desktop/Network-Security/Assignment-2$ ./mydump -r ../Assignment-1/hw1.pcap icmp

1th packet: Mon Jan 14 12:42:31 2013	IP packet	
Source MAC Address:  c4:3d:c7:17:6f:9b	Destination MAC Address:  0:c:29:e9:94:8e
Source IP Address: 1.234.31.20 	Destination IP Address: 192.168.0.200 
ICMP packet 	ICMP Type: 3 	ICMP code: 10 	ICMP length = 90 
=============
ICMP PAYLOAD:
=============
 03  0a  95  2a  00  00  00  00  45  00  00  30  00  00  40 		...*....E..0..@
 00  2e  06  6a  5a  c0  a8  00  c8  01  ea  1f  14  00  50 		...jZ.........P
 7b  81  bd  cd  09  c6  3a  35  22  b0  70  12  39  08  11 		{.....:5".p.9..
 ab  00  00  02  04  05  b4  01  01  04  02 		............9..


=======================================================================


root@neeraj:~/Desktop/Network-Security/Assignment-2$ ./mydump -r ../Assignment-1/hw1.pcap -s "magic" icmp
root@neeraj:~/Desktop/Network-Security/Assignment-2$ ./mydump -r ../Assignment-1/hw1.pcap -s "jZ" icmp

1th packet: Mon Jan 14 12:42:31 2013	IP packet	
Source MAC Address:  c4:3d:c7:17:6f:9b	Destination MAC Address:  0:c:29:e9:94:8e
Source IP Address: 1.234.31.20 	Destination IP Address: 192.168.0.200 
ICMP packet 	ICMP Type: 3 	ICMP code: 10 	ICMP length = 90 
=============
ICMP PAYLOAD:
=============
 03  0a  95  2a  00  00  00  00  45  00  00  30  00  00  40 		...*....E..0..@
 00  2e  06  6a  5a  c0  a8  00  c8  01  ea  1f  14  00  50 		...jZ.........P
 7b  81  bd  cd  09  c6  3a  35  22  b0  70  12  39  08  11 		{.....:5".p.9..
 ab  00  00  02  04  05  b4  01  01  04  02 		............9..


neeraj@neeraj:~/Desktop/Network-Security/Assignment-2$ ./mydump -r ../Assignment-1/hw1.pcap abc

Reading from pcap file: ../Assignment-1/hw1.pcap

Setting BPF filter: abc 

Failed to compile filter for device : syntax error
This syntax of BPF filter is not supported


neeraj@neeraj:~/Desktop/Network-Security/Assignment-2$ ./mydump 

Sniffing on default device: bluetooth0
^C

neeraj@neeraj:~/Desktop/Network-Security/Assignment-2$ sudo ./mydump -i eth0

Sniffing on interface: eth0

Failed to get netmask of the device !!!
Please configure the IP of the interface properly before sniffing
neeraj@neeraj:~/Desktop/Network-Security/Assignment-2$ ifconfig
eth0      Link encap:Ethernet  HWaddr f0:76:1c:1b:6a:f9  
          UP BROADCAST MULTICAST  MTU:1500  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)


=======================================================================


==========
REFERENCES
==========
http://www.tcpipguide.com/free/t_DNSMessageHeaderandQuestionSectionFormat.htm
http://www.ccs.neu.edu/home/amislove/teaching/cs4700/fall09/handouts/project1-primer.pdf
http://www.binarytides.com/dns-query-code-in-c-with-linux-sockets/
http://stackoverflow.com/questions/11770451/what-is-the-meaning-of-attribute-packed-aligned4
http://stackoverflow.com/questions/18452716/are-udp-packets-dropped-when-udp-header-checksum-is-incorrect
http://www.binarytides.com/raw-udp-sockets-c-linux/

http://www.zytrax.com/books/dns/ch15/
http://www.firewall.cx/networking-topics/protocols/domain-name-system-dns/161-protocols-dns-response.html
http://stackoverflow.com/questions/9865084/dns-response-answer-authoritative-section

http://www.binarytides.com/raw-udp-sockets-c-linux/
http://www.slashroot.in/linux-kernel-rpfilter-settings-reverse-path-filtering
http://man7.org/linux/man-pages/man3/getifaddrs.3.html
http://stackoverflow.com/questions/20800319/how-do-i-get-my-ip-address-in-c-on-linux
http://www.roman10.net/2011/11/27/how-to-calculate-iptcpudp-checksumpart-1-theory/
